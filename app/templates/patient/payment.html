{% extends "base.html" %} 
{% block title %}Payment Page{% endblock %}
{% block content %}

<div class="payment-wrapper">
  <div class="payment-container">
    <!-- Header -->
    <div class="payment-header">
      <h1 class="payment-title">Complete Your Payment</h1>
      <p class="payment-subtitle">
        Secure payment for your healthcare appointment
      </p>
    </div>

    <!-- Appointment Card -->
    <div class="payment-card">
      <div class="payment-doctor-info">
        <div class="payment-doctor-avatar">
          {% if appointment.doctor.user.doctor_profile.profile_pic %}
          <img
            src="{{ url_for('static', filename='uploads/' + appointment.doctor.user.doctor_profile.profile_pic) }}"
            alt="Dr. {{ appointment.doctor.user.name }}"
            style="
              width: 100%;
              height: 100%;
              object-fit: cover;
              border-radius: 50%;
            "
          />
          {% else %} {{ appointment.doctor.user.name[:2].upper() }} {% endif %}
        </div>
        <div class="payment-doctor-details">
          <h4>Dr. {{ appointment.doctor.user.name }}</h4>
          <p>{{ appointment.doctor.specialization or "General Physician" }}</p>
        </div>
      </div>

      <div class="payment-details">
        <div class="payment-detail-item">
          <div class="payment-detail-label">Date</div>
          <div class="payment-detail-value">{{ appointment.date }}</div>
        </div>
        <div class="payment-detail-item">
          <div class="payment-detail-label">Time</div>
          <div class="payment-detail-value">{{ appointment.time }}</div>
        </div>
      </div>

      <div class="payment-amount">
        <div class="payment-amount-label">Total Amount</div>
        <div class="payment-amount-value">â‚¹{{ appointment.doctor.fees }}</div>
      </div>
    </div>

    <!-- Payment Button -->
    <button id="rzp-button1" class="payment-pay-btn">
      <i class="fas fa-credit-card" style="margin-right: 10px"></i>
      Pay Securely with Razorpay
    </button>

    <!-- Refund Policy Notice -->
    <div class="payment-refund-notice">
      <div class="payment-refund-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <p class="payment-refund-text">
        <strong>Important:</strong> No refunds will be provided once payment is completed, even if you cancel the appointment. Please ensure you want to proceed with this booking.
      </p>
    </div>

    <!-- Security Notice -->
    <div class="payment-security">
      <div class="payment-security-icon">
        <i class="fas fa-shield-alt"></i>
      </div>
      <p class="payment-security-text">
        Your payment is secured with 256-bit SSL encryption and processed
        through Razorpay's secure gateway.
      </p>
    </div>
  </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  var options = {
      "key": "{{ razorpay_key }}", // Razorpay Key ID
      "amount": {{ appointment.doctor.fees * 100 }}, // Amount in paise
      "currency": "INR",
      "name": "E-HealthCare",
      "description": "Appointment Payment",
      "order_id": "{{ order_id }}", // Generated order ID from backend
      "handler": function (response){
          // Handle success
          fetch('/patient/payment/success/{{ appointment.id }}', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify(response)
          }).then(() => {
              window.location.href = '/patient/my-appointments';
          });
      },
      "prefill": {
          "name": "{{ current_user.name }}",
          "email": "{{ current_user.email }}"
      },
      "theme": {
          "color": "#16a2b8"
      }
  };
  var rzp1 = new Razorpay(options);
  document.getElementById('rzp-button1').onclick = function(e){
      rzp1.open();
      e.preventDefault();
  }
</script>

{% endblock %}
