{% extends "base.html" %} 
{% block title %}Patient Profile{% endblock %} 
{% block content %}

<form method="POST" enctype="multipart/form-data" id="profileForm">
  <div class="p-profile-container">
    <!-- SIDEBAR -->
    <aside class="p-profile-sidebar">
      <div class="p-profile-profile-card">
        <div class="p-profile-profile-header">
          <div class="p-profile-profile-avatar">
            {% if current_user.patient_profile.profile_pic %}
            <img
              src="{{ url_for('static', filename='uploads/' + current_user.patient_profile.profile_pic) }}"
              alt="Profile"
              style="
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 50%;
              "
            />
            {% else %} {{ current_user.name[:2].upper() }} {% endif %}
          </div>
          <div class="p-profile-profile-info">
            <div class="p-profile-profile-name">{{ current_user.name }}</div>
            <div class="p-profile-profile-id">
              ID: {{ current_user.patient_profile.id }}
            </div>
          </div>
        </div>

        <ul class="p-profile-menu">
          <li class="p-profile-menu-item">
            <a
              href="#"
              class="p-profile-menu-link p-profile-active"
              data-section="personal"
            >
              <i class="fas fa-user p-profile-menu-icon"></i>
              <span>Personal Information</span>
            </a>
          </li>
          <li class="p-profile-menu-item">
            <a href="#" class="p-profile-menu-link" data-section="medical">
              <i class="fas fa-briefcase-medical p-profile-menu-icon"></i>
              <span>Medical History</span>
            </a>
          </li>
          <li class="p-profile-menu-item">
            <a href="#" class="p-profile-menu-link" data-section="contact">
              <i class="fas fa-address-book p-profile-menu-icon"></i>
              <span>Contact</span>
            </a>
          </li>
        </ul>
      </div>
      <a
        href="{{ url_for('auth.logout') }}"
        class="p-profile-logout-btn"
        style="text-decoration: none"
      >
        <i class="fas fa-sign-out-alt"></i>
        <span>Log Out</span>
      </a>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="p-profile-main-content">
      <!-- PERSONAL -->
      <section class="p-profile-content-section" id="personalSection">
        <div class="p-profile-content-header">
          <h1 class="p-profile-page-title">Personal Information</h1>
          <button type="button" class="p-profile-edit-btn">Edit</button>
        </div>

        <p class="p-profile-last-updated">
          Last updated: {{ current_user.patient_profile.updated_at.strftime('%B
          %d, %Y') if current_user.patient_profile.updated_at else 'Never' }}
        </p>

        <div class="p-profile-section">
          <div class="p-profile-info-grid editable">
            <div class="p-profile-info-item">
              <span class="p-profile-info-label">Patient Profile</span>
              <span class="p-profile-info-value">
                {% if current_user.patient_profile.profile_pic %}
                <img
                  src="{{ url_for('static', filename='uploads/' + current_user.patient_profile.profile_pic) }}"
                  alt="Profile Picture"
                  style="
                    width: 100px;
                    height: 100px;
                    object-fit: cover;
                    border-radius: 50%;
                  "
                />
                {% else %} No profile picture uploaded {% endif %}
              </span>
            </div>
            <div class="p-profile-info-item">
              <span class="p-profile-info-label">Full Name</span>
              <span class="p-profile-info-value">{{ current_user.name }}</span>
            </div>
            <div class="p-profile-info-item">
              <span class="p-profile-info-label">Date of Birth</span>
              <span class="p-profile-info-value"
                >{{ current_user.patient_profile.date_of_birth or 'Not provided' }}</span
              >
            </div>
            <div class="p-profile-info-item">
              <span class="p-profile-info-label">Gender</span>
              <span class="p-profile-info-value"
                >{{ current_user.patient_profile.gender or 'Not provided' }}</span
              >
            </div>
            <div class="p-profile-info-item">
              <span class="p-profile-info-label">Blood Type</span>
              <span class="p-profile-info-value"
                >{{ current_user.patient_profile.blood_group or 'Not provided' }}</span
              >
            </div>
            <div class="p-profile-info-item">
              <span class="p-profile-info-label">Contact Number</span>
              <span class="p-profile-info-value"
                >{{ current_user.patient_profile.phone or 'Not provided' }}</span
              >
            </div>
          </div>
        </div>

        <div class="p-profile-section">
          <h2 class="p-profile-section-title">Allergies and Conditions</h2>
          <div class="p-profile-info-grid editable">
            <div class="p-profile-info-item">
              <span class="p-profile-info-label">Allergies</span>
              <span class="p-profile-info-value"
                >{{ current_user.patient_profile.allergies or 'Not provided' }}</span
              >
            </div>
            <div class="p-profile-info-item">
              <span class="p-profile-info-label">Chronic Conditions</span>
              <span class="p-profile-info-value"
                >{{ current_user.patient_profile.conditions or 'Not provided' }}</span
              >
            </div>
          </div>
        </div>

        <div class="p-profile-section">
          <h2 class="p-profile-section-title">Current Medications</h2>
          <div class="p-profile-info-item editable">
            <span class="p-profile-info-label">Medication List</span>
            <span class="p-profile-info-value"
              >{{ current_user.patient_profile.medications or 'Not provided' }}</span
            >
          </div>
        </div>
      </section>

      <!-- MEDICAL -->
      <section
        class="p-profile-content-section"
        id="medicalSection"
        style="display: none"
      >
        <div class="p-profile-content-header">
          <h1 class="p-profile-page-title">Medical History</h1>
          <button type="button" class="p-profile-edit-btn">Edit</button>
        </div>

        <p class="p-profile-last-updated">
          Last updated: {{ current_user.patient_profile.updated_at.strftime('%B %d, %Y') if current_user.patient_profile.updated_at else 'Never' }}
        </p>

        <div class="p-profile-section">
          <h2 class="p-profile-section-title">Previous Conditions</h2>
          <div class="p-profile-info-item editable">
            <span class="p-profile-info-label">Conditions</span>
            <span class="p-profile-info-value"
              >{{ current_user.patient_profile.previous_conditions or 'Not provided' }}</span
            >
          </div>
        </div>

        <div class="p-profile-section">
          <h2 class="p-profile-section-title">Surgeries</h2>
          <div class="p-profile-info-item editable">
            <span class="p-profile-info-label">Surgeries</span>
            <span class="p-profile-info-value"
              >{{ current_user.patient_profile.surgeries or 'Not provided' }}</span
            >
          </div>
        </div>

        <div class="p-profile-section">
          <h2 class="p-profile-section-title">Family Medical History</h2>
          <div class="p-profile-info-grid editable">
            <div class="p-profile-info-item">
              <span class="p-profile-info-label">Father's Medical History</span>
              <span class="p-profile-info-value"
                >{{ current_user.patient_profile.father_history or 'Not provided' }}</span
              >
            </div>
            <div class="p-profile-info-item">
              <span class="p-profile-info-label">Mother's Medical History</span>
              <span class="p-profile-info-value"
                >{{ current_user.patient_profile.mother_history or 'Not provided' }}</span
              >
            </div>
          </div>
        </div>

        <div class="p-profile-section">
          <h2 class="p-profile-section-title">Immunizations</h2>
          <div class="p-profile-info-item editable">
            <span class="p-profile-info-label">Immunizations</span>
            <span class="p-profile-info-value"
              >{{ current_user.patient_profile.immunizations or 'Not provided' }}</span
            >
          </div>
        </div>
      </section>

      <!-- CONTACT -->
      <section
        class="p-profile-content-section"
        id="contactSection"
        style="display: none"
      >
        <div class="p-profile-content-header">
          <h1 class="p-profile-page-title">Contact</h1>
          <button type="button" class="p-profile-edit-btn">Edit</button>
        </div>

        <p class="p-profile-last-updated">
          Last updated: {{ current_user.patient_profile.updated_at.strftime('%B %d, %Y') if current_user.patient_profile.updated_at else 'Never' }}
        </p>

        <div class="p-profile-section">
          <h2 class="p-profile-section-title">Contact Information</h2>
          <div class="p-profile-info-grid editable">
            <div class="p-profile-info-item">
              <span class="p-profile-info-label">Primary Phone</span>
              <span class="p-profile-info-value"
                >{{ current_user.patient_profile.phone or 'Not provided' }}</span
              >
            </div>
            <div class="p-profile-info-item">
              <span class="p-profile-info-label">Secondary Phone</span>
              <span class="p-profile-info-value"
                >{{ current_user.patient_profile.emergency_contact_phone or 'Not provided' }}</span
              >
            </div>
            <div class="p-profile-info-item">
              <span class="p-profile-info-label">Email Address</span>
              <span class="p-profile-info-value">{{ current_user.email }}</span>
            </div>
          </div>
        </div>
      </section>

      <button
        type="submit"
        id="saveBtn"
        style="display: none"
        class="p-profile-save-btn"
      >
        Save Changes
      </button>
    </main>
  </div>
</form>

<script>
  document.querySelectorAll(".p-profile-edit-btn").forEach((btn) => {
    btn.addEventListener("click", function () {
      const section = this.closest(".p-profile-content-section");
      section.classList.add("editing");
      section.querySelectorAll(".p-profile-info-item").forEach((item) => {
        const label = item.querySelector(".p-profile-info-label").textContent;
        const valueSpan = item.querySelector(".p-profile-info-value");
        const currentValue = valueSpan.textContent;

        let input;
        if (label === "Date of Birth") {
          input = document.createElement("input");
          input.type = "date";
          input.className = "p-profile-input";
          input.value = currentValue === "Not provided" ? "" : currentValue;
        } else if (label === "Gender") {
          input = document.createElement("select");
          input.className = "p-profile-input";
          ["Male", "Female", "Other"].forEach((option) => {
            const opt = document.createElement("option");
            opt.value = option;
            opt.textContent = option;
            if (currentValue === option) opt.selected = true;
            input.appendChild(opt);
          });
        } else if (label === "Blood Type") {
          input = document.createElement("select");
          input.className = "p-profile-input";
          ["A+", "A-", "B+", "B-", "AB+", "AB-", "O+", "O-"].forEach(
            (option) => {
              const opt = document.createElement("option");
              opt.value = option;
              opt.textContent = option;
              if (currentValue === option) opt.selected = true;
              input.appendChild(opt);
            }
          );
        } else if (label === "Patient Profile") {
          input = document.createElement("input");
          input.type = "file";
          input.className = "p-profile-input";
          input.accept = "image/*";
          input.name = "patient_profile";
          // Add preview for selected image
          input.addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function (e) {
                let preview = item.querySelector(".preview-img");
                if (!preview) {
                  preview = document.createElement("img");
                  preview.className = "preview-img";
                  preview.style.width = "100px";
                  preview.style.height = "100px";
                  preview.style.objectFit = "cover";
                  preview.style.borderRadius = "50%";
                  preview.style.marginTop = "10px";
                  item.appendChild(preview);
                }
                preview.src = e.target.result;
              };
              reader.readAsDataURL(file);
            }
          });
        } else if (
          label === "Medication List" ||
          label === "Conditions" ||
          label === "Surgeries" ||
          label === "Family History" ||
          label === "Immunizations"
        ) {
          input = document.createElement("textarea");
          input.className = "p-profile-textarea";
          input.value =
            currentValue === "None" || currentValue === "Not provided"
              ? ""
              : currentValue;
        } else {
          input = document.createElement("input");
          input.type = "text";
          input.className = "p-profile-input";
          input.value =
            currentValue === "Not provided" || currentValue === "None"
              ? ""
              : currentValue;
        }

        valueSpan.style.display = "none";
        item.appendChild(input);
      });
      this.style.display = "none";
      document.getElementById("saveBtn").style.display = "inline-block";
    });
  });

  document.getElementById("saveBtn").addEventListener("click", function () {
    const form = document.getElementById("profileForm");
    const allSections = document.querySelectorAll(".p-profile-content-section");

    allSections.forEach((section) => {
      section.querySelectorAll(".p-profile-info-item").forEach((item) => {
        const label = item.querySelector(".p-profile-info-label").textContent;
        const valueSpan = item.querySelector(".p-profile-info-value");
        const input =
          item.querySelector(".p-profile-input") ||
          item.querySelector(".p-profile-textarea");
        let value;

        if (input) {
          // If there's an input (editing), use its value
          if (input.type === "file") {
            // File input, leave it for form submission, don't set valueSpan or create hidden
            const preview = item.querySelector(".preview-img");
            if (preview) preview.remove();
            return; // Skip the rest
          }
          value = input.value.trim() || "";
          valueSpan.textContent = value || "Not provided";
          valueSpan.style.display = "block";
          input.remove();
        } else {
          // If no input (not editing), use the current span value
          value =
            valueSpan.textContent === "Not provided" ||
            valueSpan.textContent === "None"
              ? ""
              : valueSpan.textContent;
        }

        // Create hidden input for form submission
        const hiddenInput = document.createElement("input");
        hiddenInput.type = "hidden";
        hiddenInput.name = label.toLowerCase().replace(/[^a-z0-9]/g, "_");
        hiddenInput.value = value;
        form.appendChild(hiddenInput);
      });
      section.classList.remove("editing");
    });

    this.style.display = "none";
    document
      .querySelectorAll(".p-profile-edit-btn")
      .forEach((btn) => (btn.style.display = "inline-block"));
    form.submit();
  });

  // Section navigation
  const menuLinks = document.querySelectorAll(".p-profile-menu-link");
  const contentSections = document.querySelectorAll(
    ".p-profile-content-section"
  );

  menuLinks.forEach((link) => {
    link.addEventListener("click", function (e) {
      e.preventDefault();
      const targetSection = this.getAttribute("data-section");

      menuLinks.forEach((l) => l.classList.remove("p-profile-active"));
      this.classList.add("p-profile-active");

      contentSections.forEach((section) => {
        section.style.display = "none";
      });

      const sectionId = targetSection + "Section";
      document.getElementById(sectionId).style.display = "block";
    });
  });
</script>

{% endblock %}
