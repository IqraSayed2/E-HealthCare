{% extends "base.html" %}
{% block title %}Appointment Management{% endblock %}
{% block content %}

<div class="dr-apt-wrapper">

  <!-- ================= HEADER ================= -->
  <div class="dr-apt-page-header">
    <h1 class="dr-apt-page-title">Appointment Management</h1>
    <div class="dr-apt-header-actions">
      <button class="dr-apt-btn-secondary" onclick="history.back()">
        <i class="fas fa-arrow-left"></i> Back
      </button>
    </div>
  </div>

  <!-- ================= FILTERS (EXACT SAME UI) ================= -->
  <form method="GET" class="dr-apt-filter-section">
    <div class="dr-apt-filter-grid">

      <div class="dr-apt-filter-group">
        <label class="dr-apt-filter-label">Date Range</label>
        <input type="date"
               name="date"
               class="dr-apt-filter-input"
               value="{{ date_filter or '' }}">
      </div>

      <div class="dr-apt-filter-group">
        <label class="dr-apt-filter-label">Status</label>
        <select name="status" class="dr-apt-filter-select">
          <option value="all">All Status</option>
          <option value="pending" {% if status_filter=='pending' %}selected{% endif %}>Pending</option>
          <option value="accepted" {% if status_filter=='accepted' %}selected{% endif %}>Accepted</option>
          <option value="paid" {% if status_filter=='paid' %}selected{% endif %}>Paid</option>
          <option value="completed" {% if status_filter=='completed' %}selected{% endif %}>Completed</option>
          <option value="cancelled" {% if status_filter=='cancelled' %}selected{% endif %}>Cancelled</option>
        </select>
      </div>

      <div class="dr-apt-filter-group">
        <label class="dr-apt-filter-label">Consultation Type</label>
        <select name="consultation_type" class="dr-apt-filter-select">
          <option value="All Type" {% if consultation_type_filter == 'All Type' or not consultation_type_filter %}selected{% endif %}>All Type</option>
          <option value="Chat Consultation" {% if consultation_type_filter == 'Chat Consultation' %}selected{% endif %}>Chat Consultation</option>
          <option value="Video Consultation" {% if consultation_type_filter == 'Video Consultation' %}selected{% endif %}>Video Consultation</option>
          <option value="Audio Consultation" {% if consultation_type_filter == 'Audio Consultation' %}selected{% endif %}>Audio Consultation</option>
        </select>
      </div>

      <div class="dr-apt-filter-group">
        <label class="dr-apt-filter-label">Search Patient</label>
        <input type="text"
               name="search"
               value="{{ search or '' }}"
               class="dr-apt-filter-input"
               placeholder="Search by name...">
      </div>

      <div class="dr-apt-filter-group">
        <button class="dr-apt-btn-primary mt-4">
          <i class="fas fa-filter"></i> Apply
        </button>
      </div>

    </div>
  </form>

  <!-- ================= TABS ================= -->
  <div class="dr-apt-tabs-section">

    <div class="dr-apt-tabs-header">
      <button class="dr-apt-tab-btn active" onclick="switchTab('upcoming')">
        Upcoming <span class="dr-apt-tab-badge">{{ upcoming|length }}</span>
      </button>
      <button class="dr-apt-tab-btn" onclick="switchTab('accepted')">
        Accepted <span class="dr-apt-tab-badge">{{ accepted|length }}</span>
      </button>
      <button class="dr-apt-tab-btn" onclick="switchTab('pending')">
        Pending <span class="dr-apt-tab-badge">{{ pending|length }}</span>
      </button>
      <button class="dr-apt-tab-btn" onclick="switchTab('completed')">
        Completed
      </button>
      <button class="dr-apt-tab-btn" onclick="switchTab('cancelled')">
        Cancelled
      </button>
    </div>

    <!-- ================= TAB CONTENTS ================= -->
    {% for name, items, badge in [
        ('upcoming', upcoming, 'upcoming'),
        ('accepted', accepted, 'accepted'),
        ('pending', pending, 'pending'),
        ('completed', completed, 'completed'),
        ('cancelled', cancelled, 'cancelled')
    ] %}
    <div class="dr-apt-tab-content {% if loop.first %}active{% endif %}"
         id="{{ name }}-content">

      {% if items %}
        {% for appt in items %}
        <div class="dr-apt-appointment-item">

          <div class="dr-apt-appointment-details">
            <div class="dr-apt-patient-name">
              {{ appt.patient.user.name }}
            </div>

            <div class="dr-apt-appointment-info">
              <span><i class="far fa-calendar"></i> {{ appt.date }}</span>
              <span><i class="far fa-clock"></i> {{ appt.time }}</span>
            </div>
          </div>

          <div class="dr-apt-appointment-actions">
            <span class="dr-apt-status-badge {{ badge }}">
              {{ appt.status|capitalize }}
            </span>

            <a href="{{ url_for('doctor.patient_preview', patient_id=appt.patient.id) }}"
               class="dr-apt-action-btn primary">View Patient</a>

            <div class="dr-apt-action-buttons">

              {% if appt.status == 'pending' %}
                <a href="{{ url_for('doctor.accept_appointment', id=appt.id) }}"
                   class="dr-apt-action-btn success">Accept</a>
                <a href="{{ url_for('doctor.cancel_appointment', id=appt.id) }}"
                   class="dr-apt-action-btn danger">Decline</a>

              {% elif appt.status in ['accepted', 'paid'] %}
                <a href="{{ url_for('doctor.complete_appointment', id=appt.id) }}"
                   class="dr-apt-action-btn success">Complete</a>
                <a href="{{ url_for('doctor.cancel_appointment', id=appt.id) }}"
                   class="dr-apt-action-btn danger">Cancel</a>
              {% endif %}

            </div>
          </div>

        </div>
        {% endfor %}
      {% else %}
        <div class="dr-apt-empty-state">
          <div class="dr-apt-empty-icon">
            <i class="far fa-calendar-times"></i>
          </div>
          <p>No appointments found</p>
        </div>
      {% endif %}
    </div>
    {% endfor %}

  </div>
</div>

<script>
function switchTab(tab) {
  document.querySelectorAll('.dr-apt-tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.dr-apt-tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(tab + '-content').classList.add('active');
}
</script>

{% endblock %}

