{% extends "base.html" %}
{% block title %}Availability Setup{% endblock %}
{% block content %}

   <style>
      /* Main Container */
      .d-avail-container {
        max-width: 1400px;
        margin: 40px auto;
        padding: 0 40px;
      }

      .d-avail-page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 40px;
      }

      .d-avail-title-section h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 8px;
      }

      .d-avail-subtitle {
        color: #6c757d;
        font-size: 0.95rem;
      }

      .d-avail-save-btn {
        padding: 12px 28px;
        background: #16a2b8;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .d-avail-save-btn:hover {
        background: #16a2b8;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
      }

      .d-avail-content-grid {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 30px;
      }

      /* Weekly Hours Section */
      .d-avail-card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      }

      .d-avail-card-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 25px;
      }

      .d-avail-day-row {
        display: flex;
        align-items: center;
        padding: 18px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        margin-bottom: 12px;
        transition: all 0.3s ease;
      }

      .d-avail-day-row:hover {
        border-color: #d0d5dd;
      }

      .d-avail-day-row.d-avail-disabled {
        background: #f8f9fa;
      }

      .d-avail-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: #16a2b8;
      }

      .d-avail-day-label {
        font-weight: 600;
        color: #1a1a1a;
        min-width: 100px;
        margin-left: 12px;
      }

      .d-avail-day-label.d-avail-unavailable {
        color: #6c757d;
      }

      .d-avail-unavailable-text {
        font-size: 0.9rem;
        color: #6c757d;
        font-style: italic;
      }

      .d-avail-time-inputs {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
      }

      .d-avail-time-wrapper {
        position: relative;
        display: flex;
        align-items: center;
      }

      .d-avail-time-input {
        padding: 8px 35px 8px 12px;
        border: 1px solid #d0d5dd;
        border-radius: 6px;
        font-size: 0.9rem;
        width: 120px;
        cursor: pointer;
      }

      .d-avail-time-input:focus {
        outline: none;
        border-color: #16a2b8;
      }

      .d-avail-clock-icon {
        position: absolute;
        right: 10px;
        color: #6c757d;
        font-size: 0.85rem;
        pointer-events: none;
      }

      .d-avail-time-separator {
        color: #6c757d;
        font-weight: 500;
      }

      .d-avail-add-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #16a2b8;
        border: none;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .d-avail-add-btn:hover {
        background: #16a2b8;
      }

      .d-avail-hours-display {
        color: #6c757d;
        font-size: 0.9rem;
        font-weight: 500;
        min-width: 60px;
        text-align: right;
      }

      /* Calendar Section */
      .d-avail-calendar-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      }

      .d-avail-calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .d-avail-calendar-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1a1a1a;
      }

      .d-avail-calendar-nav {
        display: flex;
        gap: 10px;
      }

      .d-avail-nav-btn {
        width: 32px;
        height: 32px;
        border: 1px solid #d0d5dd;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .d-avail-nav-btn:hover {
        background: #f8f9fa;
        border-color: #adb5bd;
      }

      .d-avail-calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-bottom: 20px;
      }

      .d-avail-calendar-day-header {
        text-align: center;
        font-size: 0.8rem;
        font-weight: 600;
        color: #6c757d;
        padding: 8px 0;
      }

      .d-avail-calendar-day {
        aspect-ratio: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.2s ease;
        position: relative;
      }

      .d-avail-calendar-day:hover {
        background: #f8f9fa;
      }

      .d-avail-calendar-day.d-avail-disabled {
        color: #d0d5dd;
        cursor: default;
      }

      .d-avail-calendar-day.d-avail-today {
        background: #16a2b8;
        color: white;
      }

      .d-avail-calendar-day.d-avail-selected {
        background: #e8f0fe;
        color: #16a2b8;
      }

      .d-avail-day-indicator {
        width: 4px;
        height: 4px;
        border-radius: 50%;
        position: absolute;
        bottom: 4px;
      }

      .d-avail-indicator-d-available {
        background: #16a2b8;
      }

      .d-avail-indicator-override {
        background: #fbbc04;
      }

      .d-avail-indicator-booked {
        background: #ea4335;
      }

      .d-avail-indicator-unavailable {
        background: #d0d5dd;
      }

      .d-avail-legend {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .d-avail-legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
      }

      .d-avail-legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }

      .d-avail-legend-d-available {
        background: #16a2b8;
      }
      .d-avail-legend-override {
        background: #fbbc04;
      }
      .d-avail-legend-booked {
        background: #ea4335;
      }
      .d-avail-legend-unavailable {
        background: #d0d5dd;
      }

      /* Override Section */
      .d-avail-override-section {
        margin-top: 30px;
      }

      .d-avail-override-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 10px;
      }

      .d-avail-override-subtitle {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 20px;
      }

      .d-avail-date-select-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
        display: block;
      }

      .d-avail-date-input-wrapper {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
      }

      .d-avail-date-input {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid #d0d5dd;
        border-radius: 8px;
        font-size: 0.95rem;
      }

      .d-avail-date-input:focus {
        outline: none;
        border-color: #16a2b8;
      }

      .d-avail-block-btn {
        padding: 12px 24px;
        background: #f8f9fa;
        border: 1px solid #d0d5dd;
        border-radius: 8px;
        font-weight: 600;
        color: #495057;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .d-avail-block-btn:hover {
        background: #e9ecef;
      }

      .d-avail-upcoming-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1a1a1a;
        margin-top: 30px;
        margin-bottom: 15px;
      }

      .d-avail-override-item {
        padding: 18px;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        margin-bottom: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .d-avail-override-date {
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 4px;
      }

      .d-avail-override-label {
        font-size: 0.85rem;
        color: #fbbc04;
      }

      .d-avail-override-vacation {
        color: #16a2b8;
      }

      .d-avail-delete-btn {
        width: 36px;
        height: 36px;
        border: none;
        background: #f8f9fa;
        border-radius: 6px;
        color: #6c757d;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .d-avail-delete-btn:hover {
        background: #fee;
        color: #dc3545;
      }

      /* Mobile Responsive */
      @media (max-width: 1024px) {
        .d-avail-content-grid {
          grid-template-columns: 1fr;
        }

        .d-avail-calendar-card {
          max-width: 500px;
          margin: 0 auto;
        }
      }

      @media (max-width: 768px) {
        .d-avail-header {
          padding: 12px 20px;
        }

        .d-avail-nav {
          display: none;
        }

        .d-avail-container {
          margin: 25px auto;
          padding: 0 20px;
        }

        .d-avail-page-header {
          flex-direction: column;
          gap: 20px;
        }

        .d-avail-save-btn {
          width: 100%;
        }

        .d-avail-card {
          padding: 20px;
        }

        .d-avail-day-row {
          flex-wrap: wrap;
          gap: 10px;
        }

        .d-avail-day-label {
          min-width: auto;
          width: 100%;
        }

        .d-avail-time-inputs {
          width: 100%;
        }

        .d-avail-calendar-grid {
          gap: 4px;
        }

        .d-avail-calendar-day {
          font-size: 0.85rem;
        }
      }

      @media (max-width: 576px) {
        .d-avail-page-header h1 {
          font-size: 1.5rem;
        }

        .d-avail-card-title {
          font-size: 1.1rem;
        }

        .d-avail-time-input {
          width: 100px;
        }

        .d-avail-date-input-wrapper {
          flex-direction: column;
        }

        .d-avail-block-btn {
          width: 100%;
        }
      }
    </style>

<div class="d-avail-container">
<form method="POST">

  <!-- ================= PAGE HEADER ================= -->
  <div class="d-avail-page-header">
    <div class="d-avail-title-section">
      <h1>Availability Setup</h1>
      <p class="d-avail-subtitle">
        Manage your consultation schedule and block out time for personal events.
      </p>
    </div>
    <button class="d-avail-save-btn" type="submit">Save Changes</button>
  </div>

  <div class="d-avail-content-grid">

    <!-- ================= LEFT COLUMN ================= -->
    <div>

      <!-- ===== WEEKLY HOURS ===== -->
      <div class="d-avail-card">
        <h2 class="d-avail-card-title">Set Your Weekly Hours</h2>

        {% for day in ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"] %}
        {% set d = weekly.get(day) %}
        <div class="d-avail-day-row {% if not d %}d-avail-disabled{% endif %}">

          <input type="checkbox"
                 class="d-avail-checkbox"
                 name="{{ day }}_enabled"
                 {% if d %}checked{% endif %}>

          <label class="d-avail-day-label {% if not d %}d-avail-unavailable{% endif %}">
            {{ day }}
          </label>

          <div class="d-avail-time-inputs" {% if not d %}style="display: none;"{% endif %}>
            <div class="d-avail-time-wrapper">
              <input type="time"
                     name="{{ day }}_start"
                     class="d-avail-time-input"
                     value="{{ d.start_time if d else '09:00' }}">
              <i class="far fa-clock d-avail-clock-icon"></i>
            </div>

            <span class="d-avail-time-separator">-</span>

            <div class="d-avail-time-wrapper">
              <input type="time"
                     name="{{ day }}_end"
                     class="d-avail-time-input"
                     value="{{ d.end_time if d else '17:00' }}">
              <i class="far fa-clock d-avail-clock-icon"></i>
            </div>
          </div>

          <span class="d-avail-hours-display" {% if not d %}style="display: none;"{% endif %}>
            {% if d %}{{ ((d.end_time[:2]|int - d.start_time[:2]|int)) }} hours{% else %}8 hours{% endif %}
          </span>

          {% if not d %}
            <span class="d-avail-unavailable-text">Unavailable</span>
          {% endif %}
        </div>
        {% endfor %}
      </div>

      <!-- ===== ADD DATE OVERRIDE ===== -->
      <div class="d-avail-override-section">
        <div class="d-avail-card">

          <h2 class="d-avail-override-title">Add a Date Override</h2>
          <p class="d-avail-override-subtitle">
            Block out holidays, vacations, or set custom hours for a specific date.
          </p>

          <label class="d-avail-date-select-label">Select a date</label>
          <div class="d-avail-date-input-wrapper">
            <input type="date"
                   name="override_date"
                   class="d-avail-date-input">

            <input type="text"
                   name="override_label"
                   class="d-avail-date-input"
                   placeholder="Label (e.g., Holiday, Vacation)">

            <button type="submit" class="d-avail-block-btn">
              Block Date
            </button>
          </div>

          <h3 class="d-avail-upcoming-title">Upcoming Overrides</h3>

          {% if overrides %}
            {% for o in overrides %}
            <div class="d-avail-override-item">
              <div>
                <div class="d-avail-override-date">{{ o.date }}</div>
                <div class="d-avail-override-label">{{ o.label }}</div>
              </div>
              <button type="button" class="d-avail-delete-btn" onclick="deleteOverride({{ o.id }})">
                <i class="far fa-trash-alt"></i>
              </button>
            </div>
            {% endfor %}
          {% else %}
            <p class="text-muted">No overrides added</p>
          {% endif %}

        </div>
      </div>

    </div>

    <!-- ================= RIGHT COLUMN : CALENDAR ================= -->
    <div>
      <!-- Dynamic Calendar -->
      <div class="d-avail-calendar-card">

        <div class="d-avail-calendar-header">
          <h3 class="d-avail-calendar-title" id="calendar-title"></h3>
          <div class="d-avail-calendar-nav">
            <button type="button" class="d-avail-nav-btn" id="prev-month">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button type="button" class="d-avail-nav-btn" id="next-month">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>

        <div class="d-avail-calendar-grid" id="calendar-grid">
          <div class="d-avail-calendar-day-header">S</div>
          <div class="d-avail-calendar-day-header">M</div>
          <div class="d-avail-calendar-day-header">T</div>
          <div class="d-avail-calendar-day-header">W</div>
          <div class="d-avail-calendar-day-header">T</div>
          <div class="d-avail-calendar-day-header">F</div>
          <div class="d-avail-calendar-day-header">S</div>
          <!-- Days will be generated by JS -->
        </div>

        <div class="d-avail-legend">
          <div class="d-avail-legend-item">
            <div class="d-avail-legend-dot d-avail-legend-d-available"></div>
            <span>Available</span>
          </div>
          <div class="d-avail-legend-item">
            <div class="d-avail-legend-dot d-avail-legend-override"></div>
            <span>Override Days</span>
          </div>
          <div class="d-avail-legend-item">
            <div class="d-avail-legend-dot d-avail-legend-booked"></div>
            <span>Booked</span>
          </div>
          <div class="d-avail-legend-item">
            <div class="d-avail-legend-dot d-avail-legend-unavailable"></div>
            <span>Unavailable</span>
          </div>
        </div>

      </div>
    </div>

  </div>
</form>
</div>

<script>
  // Handle checkbox toggle
  const checkboxes = document.querySelectorAll(".d-avail-checkbox");
  checkboxes.forEach((checkbox) => {
    checkbox.addEventListener("change", function () {
      const row = this.closest(".d-avail-day-row");
      const timeInputs = row.querySelector(".d-avail-time-inputs");
      const hoursDisplay = row.querySelector(".d-avail-hours-display");
      const unavailableText = row.querySelector(".d-avail-unavailable-text");

      if (this.checked) {
        row.classList.remove("d-avail-disabled");
        if (timeInputs) timeInputs.style.display = "flex";
        if (hoursDisplay) hoursDisplay.style.display = "block";
        if (unavailableText) unavailableText.style.display = "none";
      } else {
        row.classList.add("d-avail-disabled");
        if (timeInputs) timeInputs.style.display = "none";
        if (hoursDisplay) hoursDisplay.style.display = "none";
        if (unavailableText) unavailableText.style.display = "inline";
      }
    });
  });

  // Calculate hours
  function calculateHours(startTime, endTime) {
    const [startHour, startMin] = startTime.split(":").map(Number);
    const [endHour, endMin] = endTime.split(":").map(Number);
    const hours = endHour + endMin / 60 - (startHour + startMin / 60);
    return Math.round(hours * 10) / 10;
  }

  // Update hours display when time changes
  const timeInputs = document.querySelectorAll(".d-avail-time-input");
  timeInputs.forEach((input) => {
    input.addEventListener("change", function () {
      const row = this.closest(".d-avail-day-row");
      const inputs = row.querySelectorAll(".d-avail-time-input");
      if (inputs.length === 2) {
        const hours = calculateHours(inputs[0].value, inputs[1].value);
        const display = row.querySelector(".d-avail-hours-display");
        if (display) {
          display.textContent = hours + " hours";
        }
      }
    });
  });

  // Delete override
  function deleteOverride(id) {
    if (confirm("Are you sure you want to delete this override?")) {
      fetch(`/doctor/d-availability/delete/${id}`)
        .then(response => {
          if (response.ok) {
            // Remove the item from DOM
            const deleteBtn = document.querySelector(`button[onclick="deleteOverride(${id})"]`);
            if (deleteBtn) {
              const item = deleteBtn.closest('.d-avail-override-item');
              item.remove();
            }
          } else {
            alert('Failed to delete override');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error deleting override');
        });
    }
  }

  // Add time interval
  const addButtons = document.querySelectorAll(".d-avail-add-btn");
  addButtons.forEach((btn) => {
    btn.addEventListener("click", function () {
      alert("Add additional time interval functionality would open here");
    });
  });

  // Block date button
  const blockBtn = document.querySelector(".d-avail-block-btn");
  blockBtn?.addEventListener("click", function () {
    const dateInput = document.querySelector("input[name='override_date']");
    if (dateInput.value) {
      // The form will submit
    } else {
      alert("Please select a date first");
    }
  });

  // Save changes
  const saveBtn = document.querySelector(".d-avail-save-btn");
  saveBtn?.addEventListener("click", function () {
    // The form will submit
  });

  // d-availability data from backend
  const weeklyData = {{ weekly_js|tojson }};
  const overridesData = {{ overrides_js|tojson }};
  const bookedDates = {{ booked_dates|tojson }};

  // Helper to get day name
  function getDayName(date) {
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    return days[date.getDay()];
  }

  // Helper to format date as YYYY-MM-DD (local date)
  function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  // Dynamic Calendar
  let currentDate = new Date();

  function generateCalendar(date) {
    const calendarGrid = document.getElementById('calendar-grid');
    const title = document.getElementById('calendar-title');

    // Clear existing days (keep headers)
    const headers = calendarGrid.querySelectorAll('.d-avail-calendar-day-header');
    calendarGrid.innerHTML = '';
    headers.forEach(header => calendarGrid.appendChild(header));

    // Set title
    const monthNames = [
      "January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"
    ];
    title.textContent = `${monthNames[date.getMonth()]} ${date.getFullYear()}`;

    // Get first day of month and last day
    const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
    const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // Start from previous Sunday
    const startDate = new Date(firstDay);
    startDate.setDate(firstDay.getDate() - firstDay.getDay());

    // Generate 35 days (5 weeks)
    for (let i = 0; i < 35; i++) {
      const dayDate = new Date(startDate);
      dayDate.setDate(startDate.getDate() + i);

      const dayDiv = document.createElement('div');
      dayDiv.className = 'd-avail-calendar-day';
      dayDiv.textContent = dayDate.getDate();

      // Check if disabled
      const isPast = dayDate < today;
      const isCurrentMonth = dayDate.getMonth() === date.getMonth();

      if (!isCurrentMonth || isPast) {
        dayDiv.classList.add('d-avail-disabled');
      }

      // Mark today
      if (dayDate.toDateString() === today.toDateString()) {
        dayDiv.classList.add('d-avail-today');
      }

      // Determine indicator
      if (!dayDiv.classList.contains('d-avail-disabled') || dayDiv.classList.contains('d-avail-today')) {
        const dateStr = formatDate(dayDate);
        const dayName = getDayName(dayDate);

        // Check for booked
        if (bookedDates.includes(dateStr)) {
          const indicator = document.createElement('div');
          indicator.className = 'd-avail-day-indicator d-avail-indicator-booked';
          dayDiv.appendChild(indicator);
        }
        // Check for override
        else if (overridesData.find(o => o.date === dateStr)) {
          const indicator = document.createElement('div');
          indicator.className = 'd-avail-day-indicator d-avail-indicator-override';
          dayDiv.appendChild(indicator);
        }
        // Check for weekly d-availability
        else if (weeklyData[dayName]) {
          const indicator = document.createElement('div');
          indicator.className = 'd-avail-day-indicator d-avail-indicator-d-available';
          dayDiv.appendChild(indicator);
        }
        // Default unavailable
        else {
          const indicator = document.createElement('div');
          indicator.className = 'd-avail-day-indicator d-avail-indicator-unavailable';
          dayDiv.appendChild(indicator);
        }
      }

      calendarGrid.appendChild(dayDiv);
    }
  }

  // Initialize calendar
  generateCalendar(currentDate);

  // Navigation
  document.getElementById('prev-month').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    generateCalendar(currentDate);
  });

  document.getElementById('next-month').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    generateCalendar(currentDate);
  });

  // Calendar day selection (only for current month and future)
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('d-avail-calendar-day') && !e.target.classList.contains('d-avail-disabled')) {
      document.querySelectorAll('.d-avail-calendar-day').forEach(day => day.classList.remove('d-avail-selected'));
      e.target.classList.add('d-avail-selected');
    }
  });
</script>

{% endblock %}
