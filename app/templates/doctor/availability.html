{% extends "base.html" %}
{% block title %}Availability Setup{% endblock %}
{% block content %}

<div class="d-avail-container">
<form method="POST">

  <!-- ================= PAGE HEADER ================= -->
  <div class="d-avail-page-header">
    <div class="d-avail-title-section">
      <h1>Availability Setup</h1>
      <p class="d-avail-subtitle">
        Manage your consultation schedule and block out time for personal events.
      </p>
    </div>
    <button class="d-avail-save-btn" type="submit">Save Changes</button>
  </div>

  <div class="d-avail-content-grid">

    <!-- ================= LEFT COLUMN ================= -->
    <div>

      <!-- ===== WEEKLY HOURS ===== -->
      <div class="d-avail-card">
        <h2 class="d-avail-card-title">Set Your Weekly Hours</h2>

        {% for day in ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"] %}
        {% set d = weekly.get(day) %}
        <div class="d-avail-day-row {% if not d %}d-avail-disabled{% endif %}">

          <input type="checkbox"
                 class="d-avail-checkbox"
                 name="{{ day }}_enabled"
                 {% if d %}checked{% endif %}>

          <label class="d-avail-day-label {% if not d %}d-avail-unavailable{% endif %}">
            {{ day }}
          </label>

          <div class="d-avail-time-inputs" {% if not d %}style="display: none;"{% endif %}>
            <div class="d-avail-time-wrapper">
              <input type="time"
                     name="{{ day }}_start"
                     class="d-avail-time-input"
                     value="{{ d.start_time if d else '09:00' }}">
              <i class="far fa-clock d-avail-clock-icon"></i>
            </div>

            <span class="d-avail-time-separator">-</span>

            <div class="d-avail-time-wrapper">
              <input type="time"
                     name="{{ day }}_end"
                     class="d-avail-time-input"
                     value="{{ d.end_time if d else '17:00' }}">
              <i class="far fa-clock d-avail-clock-icon"></i>
            </div>
          </div>

          <span class="d-avail-hours-display" {% if not d %}style="display: none;"{% endif %}>
            {% if d %}{{ ((d.end_time[:2]|int - d.start_time[:2]|int)) }} hours{% else %}8 hours{% endif %}
          </span>

          {% if not d %}
            <span class="d-avail-unavailable-text">Unavailable</span>
          {% endif %}
        </div>
        {% endfor %}
      </div>

      <!-- ===== ADD DATE OVERRIDE ===== -->
      <div class="d-avail-override-section">
        <div class="d-avail-card">

          <h2 class="d-avail-override-title">Add a Date Override</h2>
          <p class="d-avail-override-subtitle">
            Block out holidays, vacations, or set custom hours for a specific date.
          </p>

          <label class="d-avail-date-select-label">Select a date</label>
          <div class="d-avail-date-input-wrapper">
            <input type="date"
                   name="override_date"
                   class="d-avail-date-input">

            <input type="text"
                   name="override_label"
                   class="d-avail-date-input"
                   placeholder="Label (e.g., Holiday, Vacation)">

            <button type="submit" class="d-avail-block-btn">
              Block Date
            </button>
          </div>

          <h3 class="d-avail-upcoming-title">Upcoming Overrides</h3>

          {% if overrides %}
            {% for o in overrides %}
            <div class="d-avail-override-item">
              <div>
                <div class="d-avail-override-date">{{ o.date }}</div>
                <div class="d-avail-override-label">{{ o.label }}</div>
              </div>
              <button type="button" class="d-avail-delete-btn" onclick="deleteOverride({{ o.id }})">
                <i class="far fa-trash-alt"></i>
              </button>
            </div>
            {% endfor %}
          {% else %}
            <p class="text-muted">No overrides added</p>
          {% endif %}

        </div>
      </div>

    </div>

    <!-- ================= RIGHT COLUMN : CALENDAR ================= -->
    <div>
      <!-- Dynamic Calendar -->
      <div class="d-avail-calendar-card">

        <div class="d-avail-calendar-header">
          <h3 class="d-avail-calendar-title" id="calendar-title"></h3>
          <div class="d-avail-calendar-nav">
            <button type="button" class="d-avail-nav-btn" id="prev-month">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button type="button" class="d-avail-nav-btn" id="next-month">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>

        <div class="d-avail-calendar-grid" id="calendar-grid">
          <div class="d-avail-calendar-day-header">S</div>
          <div class="d-avail-calendar-day-header">M</div>
          <div class="d-avail-calendar-day-header">T</div>
          <div class="d-avail-calendar-day-header">W</div>
          <div class="d-avail-calendar-day-header">T</div>
          <div class="d-avail-calendar-day-header">F</div>
          <div class="d-avail-calendar-day-header">S</div>
          <!-- Days will be generated by JS -->
        </div>

        <div class="d-avail-legend">
          <div class="d-avail-legend-item">
            <div class="d-avail-legend-dot d-avail-legend-d-available"></div>
            <span>Available</span>
          </div>
          <div class="d-avail-legend-item">
            <div class="d-avail-legend-dot d-avail-legend-override"></div>
            <span>Override Days</span>
          </div>
          <div class="d-avail-legend-item">
            <div class="d-avail-legend-dot d-avail-legend-booked"></div>
            <span>Booked</span>
          </div>
          <div class="d-avail-legend-item">
            <div class="d-avail-legend-dot d-avail-legend-unavailable"></div>
            <span>Unavailable</span>
          </div>
        </div>

      </div>
    </div>

  </div>
</form>
</div>

<script>
  // Handle checkbox toggle
  const checkboxes = document.querySelectorAll(".d-avail-checkbox");
  checkboxes.forEach((checkbox) => {
    checkbox.addEventListener("change", function () {
      const row = this.closest(".d-avail-day-row");
      const timeInputs = row.querySelector(".d-avail-time-inputs");
      const hoursDisplay = row.querySelector(".d-avail-hours-display");
      const unavailableText = row.querySelector(".d-avail-unavailable-text");

      if (this.checked) {
        row.classList.remove("d-avail-disabled");
        if (timeInputs) timeInputs.style.display = "flex";
        if (hoursDisplay) hoursDisplay.style.display = "block";
        if (unavailableText) unavailableText.style.display = "none";
      } else {
        row.classList.add("d-avail-disabled");
        if (timeInputs) timeInputs.style.display = "none";
        if (hoursDisplay) hoursDisplay.style.display = "none";
        if (unavailableText) unavailableText.style.display = "inline";
      }
    });
  });

  // Calculate hours
  function calculateHours(startTime, endTime) {
    const [startHour, startMin] = startTime.split(":").map(Number);
    const [endHour, endMin] = endTime.split(":").map(Number);
    const hours = endHour + endMin / 60 - (startHour + startMin / 60);
    return Math.round(hours * 10) / 10;
  }

  // Update hours display when time changes
  const timeInputs = document.querySelectorAll(".d-avail-time-input");
  timeInputs.forEach((input) => {
    input.addEventListener("change", function () {
      const row = this.closest(".d-avail-day-row");
      const inputs = row.querySelectorAll(".d-avail-time-input");
      if (inputs.length === 2) {
        const hours = calculateHours(inputs[0].value, inputs[1].value);
        const display = row.querySelector(".d-avail-hours-display");
        if (display) {
          display.textContent = hours + " hours";
        }
      }
    });
  });

  // Delete override
  function deleteOverride(id) {
    if (confirm("Are you sure you want to delete this override?")) {
      fetch(`/doctor/d-availability/delete/${id}`)
        .then(response => {
          if (response.ok) {
            // Remove the item from DOM
            const deleteBtn = document.querySelector(`button[onclick="deleteOverride(${id})"]`);
            if (deleteBtn) {
              const item = deleteBtn.closest('.d-avail-override-item');
              item.remove();
            }
          } else {
            alert('Failed to delete override');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error deleting override');
        });
    }
  }

  // Add time interval
  const addButtons = document.querySelectorAll(".d-avail-add-btn");
  addButtons.forEach((btn) => {
    btn.addEventListener("click", function () {
      alert("Add additional time interval functionality would open here");
    });
  });

  // Block date button
  const blockBtn = document.querySelector(".d-avail-block-btn");
  blockBtn?.addEventListener("click", function () {
    const dateInput = document.querySelector("input[name='override_date']");
    if (dateInput.value) {
      // The form will submit
    } else {
      alert("Please select a date first");
    }
  });

  // Save changes
  const saveBtn = document.querySelector(".d-avail-save-btn");
  saveBtn?.addEventListener("click", function () {
    // The form will submit
  });

  // d-availability data from backend
  const weeklyData = {{ weekly_js|tojson }};
  const overridesData = {{ overrides_js|tojson }};
  const bookedDates = {{ booked_dates|tojson }};

  // Helper to get day name
  function getDayName(date) {
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    return days[date.getDay()];
  }

  // Helper to format date as YYYY-MM-DD (local date)
  function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  // Dynamic Calendar
  let currentDate = new Date();

  function generateCalendar(date) {
    const calendarGrid = document.getElementById('calendar-grid');
    const title = document.getElementById('calendar-title');

    // Clear existing days (keep headers)
    const headers = calendarGrid.querySelectorAll('.d-avail-calendar-day-header');
    calendarGrid.innerHTML = '';
    headers.forEach(header => calendarGrid.appendChild(header));

    // Set title
    const monthNames = [
      "January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"
    ];
    title.textContent = `${monthNames[date.getMonth()]} ${date.getFullYear()}`;

    // Get first day of month and last day
    const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
    const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // Start from previous Sunday
    const startDate = new Date(firstDay);
    startDate.setDate(firstDay.getDate() - firstDay.getDay());

    // Generate 35 days (5 weeks)
    for (let i = 0; i < 35; i++) {
      const dayDate = new Date(startDate);
      dayDate.setDate(startDate.getDate() + i);

      const dayDiv = document.createElement('div');
      dayDiv.className = 'd-avail-calendar-day';
      dayDiv.textContent = dayDate.getDate();

      // Check if disabled
      const isPast = dayDate < today;
      const isCurrentMonth = dayDate.getMonth() === date.getMonth();

      if (!isCurrentMonth || isPast) {
        dayDiv.classList.add('d-avail-disabled');
      }

      // Mark today
      if (dayDate.toDateString() === today.toDateString()) {
        dayDiv.classList.add('d-avail-today');
      }

      // Determine indicator
      if (!dayDiv.classList.contains('d-avail-disabled') || dayDiv.classList.contains('d-avail-today')) {
        const dateStr = formatDate(dayDate);
        const dayName = getDayName(dayDate);

        // Check for booked
        if (bookedDates.includes(dateStr)) {
          const indicator = document.createElement('div');
          indicator.className = 'd-avail-day-indicator d-avail-indicator-booked';
          dayDiv.appendChild(indicator);
        }
        // Check for override
        else if (overridesData.find(o => o.date === dateStr)) {
          const indicator = document.createElement('div');
          indicator.className = 'd-avail-day-indicator d-avail-indicator-override';
          dayDiv.appendChild(indicator);
        }
        // Check for weekly d-availability
        else if (weeklyData[dayName]) {
          const indicator = document.createElement('div');
          indicator.className = 'd-avail-day-indicator d-avail-indicator-d-available';
          dayDiv.appendChild(indicator);
        }
        // Default unavailable
        else {
          const indicator = document.createElement('div');
          indicator.className = 'd-avail-day-indicator d-avail-indicator-unavailable';
          dayDiv.appendChild(indicator);
        }
      }

      calendarGrid.appendChild(dayDiv);
    }
  }

  // Initialize calendar
  generateCalendar(currentDate);

  // Navigation
  document.getElementById('prev-month').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    generateCalendar(currentDate);
  });

  document.getElementById('next-month').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    generateCalendar(currentDate);
  });

  // Calendar day selection (only for current month and future)
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('d-avail-calendar-day') && !e.target.classList.contains('d-avail-disabled')) {
      document.querySelectorAll('.d-avail-calendar-day').forEach(day => day.classList.remove('d-avail-selected'));
      e.target.classList.add('d-avail-selected');
    }
  });
</script>

{% endblock %}
