{% extends "base.html" %} 
{% block title %}Doctor Profile{% endblock %} 
{% block content %}

<form method="POST" id="profileForm" enctype="multipart/form-data">
  <div class="d-profile-container">
    <!-- SIDEBAR -->
    <aside class="d-profile-sidebar">
      <div class="d-profile-profile-card">
        <div class="d-profile-profile-header">
          <div class="d-profile-profile-avatar">
            {% if current_user.doctor_profile.profile_pic %}
              <img src="{{ url_for('static', filename='uploads/' + current_user.doctor_profile.profile_pic) }}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
            {% else %}
              {{ current_user.name[:2].upper() }}
            {% endif %}
          </div>
          <div class="d-profile-profile-info">
            <div class="d-profile-profile-name">{{ current_user.name }}</div>
            <div class="d-profile-profile-id">
              ID: {{ current_user.doctor_profile.id }}
            </div>
          </div>
        </div>

        <ul class="d-profile-menu">
          <li class="d-profile-menu-item">
            <a
              href="#"
              class="d-profile-menu-link d-profile-active"
              data-section="personal"
            >
              <i class="fas fa-user d-profile-menu-icon"></i>
              <span>Personal Information</span>
            </a>
          </li>
          <li class="d-profile-menu-item">
            <a href="#" class="d-profile-menu-link" data-section="qualification">
              <i class="fas fa-graduation-cap d-profile-menu-icon"></i>
              <span>Qualification & Credentials</span>
            </a>
          </li>
          <li class="d-profile-menu-item">
            <a href="#" class="d-profile-menu-link" data-section="clinic">
              <i class="fas fa-hospital d-profile-menu-icon"></i>
              <span>Clinic/Hospital Information</span>
            </a>
          </li>
          <li class="d-profile-menu-item">
            <a href="#" class="d-profile-menu-link" data-section="additional">
              <i class="fas fa-info-circle d-profile-menu-icon"></i>
              <span>Additional Information</span>
            </a>
          </li>
        </ul>
      </div>
      <button class="d-profile-logout-btn">
        <i class="fas fa-sign-out-alt"></i>
        <span>Log Out</span>
      </button>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="d-profile-main-content">
      <!-- PERSONAL -->
      <section class="d-profile-content-section" id="personalSection">
        <div class="d-profile-content-header">
          <h1 class="d-profile-page-title">Personal Information</h1>
          <button type="button" class="d-profile-edit-btn">Edit</button>
        </div>

        <p class="d-profile-last-updated">
          Last updated: {{ current_user.doctor_profile.updated_at.strftime('%B %d, %Y') if current_user.doctor_profile.updated_at else 'Never' }}
        </p>

        <div class="d-profile-section">
          <div class="d-profile-info-grid editable">
            <div class="d-profile-info-item">
              <span class="d-profile-info-label">Doctor Profile</span>
              <span class="d-profile-info-value">
                {% if current_user.doctor_profile.profile_pic %}
                  <img src="{{ url_for('static', filename='uploads/' + current_user.doctor_profile.profile_pic) }}" alt="Profile Picture" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%;">
                {% else %}
                  No profile picture uploaded
                {% endif %}
              </span>
            </div>
            <div class="d-profile-info-item">
              <span class="d-profile-info-label">Full Name</span>
              <span class="d-profile-info-value">{{ current_user.name }}</span>
            </div>
            <div class="d-profile-info-item">
              <span class="d-profile-info-label">Contact</span>
              <span class="d-profile-info-value"
                >{{ current_user.doctor_profile.phone or 'Not provided' }}</span
              >
            </div>
            <div class="d-profile-info-item">
              <span class="d-profile-info-label">Email ID</span>
              <span class="d-profile-info-value">{{ current_user.email }}</span>
            </div>
            <div class="d-profile-info-item">
              <span class="d-profile-info-label">Date of Birth</span>
              <span class="d-profile-info-value"
                >{{ current_user.doctor_profile.date_of_birth or 'Not provided' }}</span
              >
            </div>
            <div class="d-profile-info-item">
              <span class="d-profile-info-label">Gender</span>
              <span class="d-profile-info-value"
                >{{ current_user.doctor_profile.gender or 'Not provided' }}</span
              >
            </div>
            <div class="d-profile-info-item">
              <span class="d-profile-info-label">Medical Licence No.</span>
              <span class="d-profile-info-value"
                >{{ current_user.doctor_profile.medical_licence_no or 'Not provided' }}</span
              >
            </div>
            <div class="d-profile-info-item">
              <span class="d-profile-info-label">Years of Experience</span>
              <span class="d-profile-info-value"
                >{{ current_user.doctor_profile.experience or 'Not provided' }}</span
              >
            </div>
            <div class="d-profile-info-item">
              <span class="d-profile-info-label">Primary Specialization</span>
              <span class="d-profile-info-value"
                >{{ current_user.doctor_profile.specialization or 'Not provided'}}</span
              >
            </div>
            <div class="d-profile-info-item">
              <span class="d-profile-info-label">Secondary Specialization</span>
              <span class="d-profile-info-value"
                >{{ current_user.doctor_profile.secondary_specialization or 'Not provided' }}</span
              >
            </div>
            <div class="d-profile-info-item">
              <span class="d-profile-info-label">Consultation Fees</span>
              <span class="d-profile-info-value"
                >{{ '₹' + current_user.doctor_profile.fees|string if current_user.doctor_profile.fees else 'Not provided' }}</span
              >
            </div>
            <div class="d-profile-info-item">
              <span class="d-profile-info-label">Professional Bio</span>
              <span class="d-profile-info-value" data-original="{{ current_user.doctor_profile.about }}">{{ current_user.doctor_profile.about.replace('\n', '<br>') | safe if current_user.doctor_profile.about else 'Not provided' }}</span>
            </div>
          </div>
        </div>
      </section>

      <!-- QUALIFICATION -->
      <section
        class="d-profile-content-section"
        id="qualificationSection"
        style="display: none"
      >
        <div class="d-profile-content-header">
          <h1 class="d-profile-page-title">Qualification & Credentials</h1>
          <button type="button" class="d-profile-edit-btn">Edit</button>
        </div>

        <p class="d-profile-last-updated">
          Last updated: {{ current_user.doctor_profile.updated_at.strftime('%B %d, %Y') if current_user.doctor_profile.updated_at else 'Never' }}
        </p>

        <div class="d-profile-section">
          <div class="d-profile-info-grid editable">
            <div class="d-profile-info-item">
              <span class="d-profile-info-label">Medical Degree</span>
              <span class="d-profile-info-value"
                >{{ current_user.doctor_profile.medical_degree or 'Not provided' }}</span
              >
            </div>
            <div class="d-profile-info-item">
              <span class="d-profile-info-label">Medical School</span>
              <span class="d-profile-info-value"
                >{{ current_user.doctor_profile.medical_school or 'Not provided' }}</span
              >
            </div>
            <div class="d-profile-info-item">
              <span class="d-profile-info-label">Graduation Year</span>
              <span class="d-profile-info-value"
                >{{ current_user.doctor_profile.graduation_year or 'Not provided' }}</span
              >
            </div>
            <div class="d-profile-info-item">
              <span class="d-profile-info-label">Board Certifications</span>
              <span class="d-profile-info-value" data-original="{{ current_user.doctor_profile.board_certifications }}">{{ current_user.doctor_profile.board_certifications.replace('\n', '<br>') | safe if current_user.doctor_profile.board_certifications else 'Not provided' }}</span>
            </div>
            <div class="d-profile-info-item">
              <span class="d-profile-info-label">Upload Medical Licence</span>
              <span class="d-profile-info-value">
                {% if current_user.doctor_profile.licence_file %}
                  {% if current_user.doctor_profile.licence_file.lower().endswith(('.png', '.jpg', '.jpeg', '.gif', '.bmp')) %}
                    <img src="{{ url_for('static', filename='uploads/' + current_user.doctor_profile.licence_file) }}" alt="Medical Licence" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%;">
                  {% else %}
                    <a href="{{ url_for('static', filename='uploads/' + current_user.doctor_profile.licence_file) }}" target="_blank" style="text-decoration: none; color: #1a1a1a;">{{ current_user.doctor_profile.licence_file }}</a>
                  {% endif %}
                {% else %}
                  Not uploaded
                {% endif %}
              </span>
            </div>
          </div>
        </div>
      </section>

      <!-- CLINIC -->
      <section
        class="d-profile-content-section"
        id="clinicSection"
        style="display: none"
      >
        <div class="d-profile-content-header">
          <h1 class="d-profile-page-title">Clinic/Hospital Information</h1>
          <button type="button" class="d-profile-edit-btn">Edit</button>
        </div>

        <p class="d-profile-last-updated">
          Last updated: {{ current_user.doctor_profile.updated_at.strftime('%B %d, %Y') if current_user.doctor_profile.updated_at else 'Never' }}
        </p>

        <div class="d-profile-section">
          <div class="d-profile-info-grid editable">
            <div class="d-profile-info-item">
              <span class="d-profile-info-label">Clinic/Hospital Name</span>
              <span class="d-profile-info-value"
                >{{ current_user.doctor_profile.clinic_name or 'Not provided'}}</span
              >
            </div>
            <div class="d-profile-info-item">
              <span class="d-profile-info-label">Address</span>
              <span class="d-profile-info-value"
                >{{ current_user.doctor_profile.clinic_address or 'Not provided'}}</span
              >
            </div>
            <div class="d-profile-info-item">
              <span class="d-profile-info-label">City</span>
              <span class="d-profile-info-value"
                >{{ current_user.doctor_profile.clinic_city or 'Not provided'}}</span
              >
            </div>
            <div class="d-profile-info-item">
              <span class="d-profile-info-label">State</span>
              <span class="d-profile-info-value"
                >{{ current_user.doctor_profile.clinic_state or 'Not provided'}}</span
              >
            </div>
            <div class="d-profile-info-item">
              <span class="d-profile-info-label">Country</span>
              <span class="d-profile-info-value"
                >{{ current_user.doctor_profile.clinic_country or 'Not provided'}}</span
              >
            </div>
            <div class="d-profile-info-item">
              <span class="d-profile-info-label">Zip Code</span>
              <span class="d-profile-info-value"
                >{{ current_user.doctor_profile.clinic_zip_code or 'Not provided'}}</span
              >
            </div>
          </div>
        </div>
      </section>

      <!-- ADDITIONAL -->
      <section
        class="d-profile-content-section"
        id="additionalSection"
        style="display: none"
      >
        <div class="d-profile-content-header">
          <h1 class="d-profile-page-title">Additional Information</h1>
          <button type="button" class="d-profile-edit-btn">Edit</button>
        </div>

        <p class="d-profile-last-updated">
          Last updated: {{ current_user.doctor_profile.updated_at.strftime('%B  %d, %Y') if current_user.doctor_profile.updated_at else 'Never' }}
        </p>

        <div class="d-profile-section">
          <div class="d-profile-info-item editable">
            <span class="d-profile-info-label">Areas of Expertise</span>
            <span class="d-profile-info-value" data-original="{{ current_user.doctor_profile.areas_of_expertise }}">{{ current_user.doctor_profile.areas_of_expertise.replace('\n', '<br>') | safe if current_user.doctor_profile.areas_of_expertise else 'Not provided' }}</span>
          </div>
        </div>

        <div class="d-profile-section">
          <div class="d-profile-info-item editable">
            <span class="d-profile-info-label">Awards and Recognition</span>
            <span class="d-profile-info-value" data-original="{{ current_user.doctor_profile.awards_recognitions }}">{{ current_user.doctor_profile.awards_recognitions.replace('\n', '<br>') | safe if current_user.doctor_profile.awards_recognitions else 'Not provided' }}</span>
          </div>
        </div>

        <div class="d-profile-section">
          <div class="d-profile-info-item editable">
            <span class="d-profile-info-label">Research & Publications</span>
            <span class="d-profile-info-value" data-original="{{ current_user.doctor_profile.research_publications }}">{{ current_user.doctor_profile.research_publications.replace('\n', '<br>') | safe if current_user.doctor_profile.research_publications else 'Not provided' }}</span>
          </div>
        </div>

        <div class="d-profile-section">
          <div class="d-profile-info-item editable">
            <span class="d-profile-info-label">Professional Membership</span>
            <span class="d-profile-info-value" data-original="{{ current_user.doctor_profile.professional_memberships }}">{{ current_user.doctor_profile.professional_memberships.replace('\n', '<br>') | safe if current_user.doctor_profile.professional_memberships else 'Not provided' }}</span>
          </div>
        </div>
      </section>

      <button
        type="submit"
        id="saveBtn"
        style="display: none"
        class="d-profile-save-btn"
      >
        Save Changes
      </button>
    </main>
  </div>
</form>

<script>
  document.querySelectorAll(".d-profile-edit-btn").forEach((btn) => {
    btn.addEventListener("click", function () {
      const section = this.closest(".d-profile-content-section");
      section.classList.add("editing");
      section.querySelectorAll(".d-profile-info-item").forEach((item) => {
        const label = item.querySelector(".d-profile-info-label").textContent;
        const valueSpan = item.querySelector(".d-profile-info-value");
        const currentValue = valueSpan.textContent;

        let input;
        const specializations = [
          "General Physician", "Cardiologist", "Dermatologist", "Pediatrician", 
          "Orthopedic Surgeon", "Neurologist", "Psychiatrist", "Gynecologist", 
          "Ophthalmologist", "ENT Specialist", "Dentist", "Radiologist", 
          "Pathologist", "Surgeon", "Urologist", "Nephrologist", "Endocrinologist", 
          "Oncologist", "Pulmonologist", "Gastroenterologist", "Rheumatologist", 
          "Hematologist", "Infectious Disease Specialist", "Allergist", 
          "Plastic Surgeon", "Neurosurgeon", "Cardiothoracic Surgeon", "Vascular Surgeon"
        ];

        if (label === "Date of Birth") {
          input = document.createElement("input");
          input.type = "date";
          input.className = "d-profile-input";
          input.value = currentValue === "Not provided" ? "" : currentValue;
        } else if (label === "Gender") {
          input = document.createElement("select");
          input.className = "d-profile-input";
          ["Male", "Female", "Other"].forEach((option) => {
            const opt = document.createElement("option");
            opt.value = option;
            opt.textContent = option;
            if (currentValue === option) opt.selected = true;
            input.appendChild(opt);
          });
        } else if (label === "Primary Specialization" || label === "Secondary Specialization") {
          input = document.createElement("select");
          input.className = "d-profile-input";
          const defaultOpt = document.createElement("option");
          defaultOpt.value = "";
          defaultOpt.textContent = "Select Specialization";
          input.appendChild(defaultOpt);
          specializations.forEach((spec) => {
            const opt = document.createElement("option");
            opt.value = spec;
            opt.textContent = spec;
            if (currentValue === spec) opt.selected = true;
            input.appendChild(opt);
          });
        } else if (label === "Upload Medical Licence") {
          input = document.createElement("input");
          input.type = "file";
          input.className = "d-profile-input";
          input.accept = "image/*,.pdf";
          input.name = "upload_medical_licence";
        } else if (label === "Doctor Profile") {
          input = document.createElement("input");
          input.type = "file";
          input.className = "d-profile-input";
          input.accept = "image/*";
          input.name = "doctor_profile";
          // Add preview for selected image
          input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function(e) {
                let preview = item.querySelector('.preview-img');
                if (!preview) {
                  preview = document.createElement('img');
                  preview.className = 'preview-img';
                  preview.style.width = '100px';
                  preview.style.height = '100px';
                  preview.style.objectFit = 'cover';
                  preview.style.borderRadius = '50%';
                  preview.style.marginTop = '10px';
                  item.appendChild(preview);
                }
                preview.src = e.target.result;
              };
              reader.readAsDataURL(file);
            }
          });
        } else if (label === "Graduation Year") {
          input = document.createElement("input");
          input.type = "number";
          input.className = "d-profile-input";
          input.min = "1900";
          input.max = new Date().getFullYear();
          input.value = currentValue === "Not provided" ? "" : currentValue;
        } else if (
          [
            "Professional Bio",
            "Board Certifications",
            "Areas of Expertise",
            "Awards and Recognition",
            "Research & Publications",
            "Professional Membership",
          ].includes(label)
        ) {
          input = document.createElement("textarea");
          input.className = "d-profile-textarea";
          input.value = item.querySelector('.d-profile-info-value').dataset.original || '';
        } else {
          input = document.createElement("input");
          input.type = "text";
          input.className = "d-profile-input";
          input.value = currentValue === "Not provided" ? "" : currentValue;
        }

        valueSpan.style.display = "none";
        item.appendChild(input);
      });
      this.style.display = "none";
      document.getElementById("saveBtn").style.display = "inline-block";
    });
  });

  document.getElementById("saveBtn").addEventListener("click", function () {
    const form = document.getElementById("profileForm");
    const allSections = document.querySelectorAll(".d-profile-content-section");

    allSections.forEach((section) => {
      section.querySelectorAll(".d-profile-info-item").forEach((item) => {
        const label = item.querySelector(".d-profile-info-label").textContent;
        const valueSpan = item.querySelector(".d-profile-info-value");
        const input =
          item.querySelector(".d-profile-input") ||
          item.querySelector(".d-profile-textarea");
        let value;

        if (input) {
          // If there's an input (editing), use its value
          if (input.type === 'file') {
            // File input, leave it for form submission, don't set valueSpan or create hidden
            const preview = item.querySelector('.preview-img');
            if (preview) preview.remove();
            return; // Skip the rest
          }
          value = input.value.trim() || "Not provided";
          if (input.tagName === 'TEXTAREA') {
            valueSpan.innerHTML = value.replace(/\n/g, '<br>');
            valueSpan.dataset.original = value;
          } else {
            valueSpan.textContent = value;
          }
          input.remove();
        } else {
          // If no input (not editing), use the current span value
          if (label === "Consultation Fees") {
            value = valueSpan.textContent.replace('₹', '').trim() === "Not provided" ? "" : valueSpan.textContent.replace('₹', '').trim();
          } else if (label === "Upload Medical Licence" || label === "Doctor Profile") {
            // Skip creating hidden for file fields
            return;
          } else if (valueSpan.dataset.original !== undefined) {
            value = valueSpan.dataset.original;
          } else {
            value = valueSpan.textContent === "Not provided" ? "" : valueSpan.textContent;
          }
        }

        // Create hidden input for form submission
        const hiddenInput = document.createElement("input");
        hiddenInput.type = "hidden";
        hiddenInput.name = label.toLowerCase().replace(/[^a-z0-9]/g, "_");
        hiddenInput.value = value;
        form.appendChild(hiddenInput);
      });
      section.classList.remove("editing");
    });

    this.style.display = "none";
    document
      .querySelectorAll(".d-profile-edit-btn")
      .forEach((btn) => (btn.style.display = "inline-block"));
    form.submit();
  });

  // Section navigation
  const menuLinks = document.querySelectorAll(".d-profile-menu-link");
  const contentSections = document.querySelectorAll(".d-profile-content-section");

  menuLinks.forEach((link) => {
    link.addEventListener("click", function (e) {
      e.preventDefault();
      const targetSection = this.getAttribute("data-section");

      menuLinks.forEach((l) => l.classList.remove("d-profile-active"));
      this.classList.add("d-profile-active");

      contentSections.forEach((section) => {
        section.style.display = "none";
      });

      const sectionId = targetSection + "Section";
      document.getElementById(sectionId).style.display = "block";
    });
  });
</script>

{% endblock %}
